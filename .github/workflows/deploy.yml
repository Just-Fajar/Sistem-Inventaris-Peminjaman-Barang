name: Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment: production
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          ssh $SERVER_USER@$SERVER_HOST << 'ENDSSH'
            set -e
            
            echo "ðŸš€ Starting deployment..."
            
            # Navigate to project
            cd ${{ secrets.DEPLOY_PATH }}
            
            # Enable maintenance mode
            php artisan down || true
            
            # Pull latest code
            git fetch origin main
            git reset --hard origin/main
            
            # Backend dependencies
            composer install --no-dev --optimize-autoloader --no-interaction
            
            # Run migrations
            php artisan migrate --force
            
            # Clear and cache config
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache
            
            # Restart queue workers
            php artisan queue:restart
            
            # Frontend build
            cd frontend
            npm ci --production=false
            npm run build
            cd ..
            
            # Set permissions
            chown -R www-data:www-data storage bootstrap/cache
            chmod -R 775 storage bootstrap/cache
            
            # Disable maintenance mode
            php artisan up
            
            echo "âœ… Deployment completed successfully!"
          ENDSSH

      - name: Health check
        run: |
          sleep 10
          curl -f ${{ secrets.APP_URL }}/api/health || exit 1

      - name: Notify on success
        if: success()
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
            -H 'Content-Type: application/json' \
            -d '{"text":"âœ… Deployment to production succeeded!"}'

      - name: Notify on failure
        if: failure()
        run: |
          curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
            -H 'Content-Type: application/json' \
            -d '{"text":"âŒ Deployment to production failed!"}'

      - name: Rollback on failure
        if: failure()
        env:
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_USER: ${{ secrets.SERVER_USER }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          ssh $SERVER_USER@$SERVER_HOST << 'ENDSSH'
            cd ${{ secrets.DEPLOY_PATH }}
            git reset --hard HEAD~1
            composer install --no-dev --optimize-autoloader
            php artisan migrate:rollback
            php artisan config:cache
            php artisan route:cache
            php artisan up
          ENDSSH
